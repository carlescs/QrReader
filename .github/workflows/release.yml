name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v5.2.0

permissions:
  contents: write
  packages: write

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-release:
    name: Build and Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Build Release Bundle (AAB)
        run: ./gradlew bundleRelease

      - name: Get version name
        id: version
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName | tail -n 1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME"

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "release_notes=Initial release" >> $GITHUB_OUTPUT
          else
            # Generate changelog from commits between tags
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.version_name }}
          body: |
            ## What's Changed
            ${{ steps.release_notes.outputs.release_notes }}
            
            ## Installation
            Download the APK below and install on your Android device.
            
            **Version Code:** Auto-generated from Git
            **Version Name:** ${{ steps.version.version_name }}
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
