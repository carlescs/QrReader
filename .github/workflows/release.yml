name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v5.2.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 5.2.0 or v5.2.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-release:
    name: Build and Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Ensure version starts with 'v'
          if [[ "$VERSION" != v* ]]; then
            VERSION="v$VERSION"
          fi
          # Validate version format: vMAJOR.MINOR.PATCH
          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format '$VERSION'. Expected format: 1.2.3 or v1.2.3"
            exit 1
          fi
          # Fail early if the tag already exists
          if git tag -l "$VERSION" | grep -q "^$VERSION$"; then
            echo "::error::Tag $VERSION already exists. Use a different version number."
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "TAG_NAME=$VERSION" >> $GITHUB_ENV

      - name: Set tag name (push trigger)
        if: github.event_name == 'push'
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Build Release Bundle (AAB)
        run: ./gradlew bundleRelease

      - name: Get version name
        id: version
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName | tail -n 1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME"

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag (excluding the current one)
          CURRENT_TAG="${{ env.TAG_NAME }}"
          # Use a compatible approach that works with older Git versions
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^$CURRENT_TAG$" | head -n 1)
          
          if [ -z "$PREV_TAG" ]; then
            echo "release_notes=Initial release" >> $GITHUB_OUTPUT
          else
            # Generate changelog from commits between tags
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Release ${{ steps.version.outputs.version_name }}
          body: |
            ## What's Changed
            ${{ steps.release_notes.outputs.release_notes }}
            
            ## Installation
            Download the APK below and install on your Android device.
            
            **Version Code:** Auto-generated from Git
            **Version Name:** ${{ steps.version.outputs.version_name }}
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
